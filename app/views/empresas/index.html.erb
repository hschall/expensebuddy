<h3>Empresas</h3>

<!-- 🔘 Top Actions -->
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  <%#= button_to "Importar nuevas empresas desde transacciones", import_from_transactions_empresas_path,
                method: :post, class: "btn-custom-action-sm" %>

  <%#= button_to "Actualizar categorías en base de datos", update_all_transaction_categories_empresas_path,
                method: :post, class: "btn-custom-action-sm btn-sm" %>

  <%= link_to "Ver Sin categorizar", empresas_path(estado_filter: "sin_categorizar", identificador_filter: "", categoria_filter: "", search: "", commit: "Filtrar"), class: "btn-custom-action-sm btn-sm" %>

</div>



<!-- 🔍 Filter Form -->
<%= form_with url: empresas_path, method: :get, local: true, class: "mb-4 row g-2 align-items-end" do %>
  <div class="col-auto">
    <%= label_tag :identificador_filter, "RFC", class: "form-label" %>
    <%= select_tag :identificador_filter,
          options_for_select([["Todos", ""], ["Con RFC", "con"], ["Sin RFC", "sin"]],
          selected: params[:identificador_filter]),
          class: "form-select form-select-sm" %>
  </div>

  <div class="col-auto">
  <%= label_tag :estado_filter, "Estado", class: "form-label" %>
  <%= select_tag :estado_filter,
        options_for_select([
          ["Todos", ""],
          ["Categorizado", "categorizado"],
          ["Sin categorizar", "sin_categorizar"]
        ], selected: params[:estado_filter]),
        class: "form-select form-select-sm" %>
</div>


 <div class="col-auto">
  <%= label_tag :categoria_filter, "Categoría", class: "form-label" %>
  <%= select_tag :categoria_filter,
        options_for_select(
          [["Todas", ""]] +
          current_user.categories
                      .where.not(name: "Sin categoría")
                      .order(:name)
                      .pluck(:name)
                      .map { |c| [c, c] },
          selected: params[:categoria_filter]
        ),
        class: "form-select form-select-sm" %>
</div>


  <div class="col-auto">
    <%= label_tag :search, "Buscar descripción", class: "form-label" %>
    <%= text_field_tag :search, params[:search], placeholder: "Ej: OXXO, Soriana...", class: "form-control form-control-sm" %>
  </div>

  <div class="col-auto d-flex gap-2">
    <%= submit_tag "Filtrar", class: "btn-custom-primary-sm" %>

    <% if params[:identificador_filter].present? || params[:estado_filter].present? || params[:categoria_filter].present? || params[:search].present? %>
      <%= link_to "Quitar filtros", empresas_path, class: "btn-custom-primary-sm btn-sm" %>
    <% end %>
  </div>
<% end %>


<!-- 🧾 Empresa Table Form -->
<%= form_with url: "", method: :post, id: "empresas_form", data: { turbo: false } do %>
  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

  <div class="d-flex justify-content-start mb-2">
    <!-- Save Changes -->
    <%= submit_tag "Guardar cambios", class: "btn-custom-save-sm me-2", data: { action: "guardar" } %>

    <!-- Delete Selected -->
    <%= submit_tag "Eliminar seleccionadas", class: "btn-custom-danger-sm", data: { action: "eliminar", turbo_confirm: "¿Eliminar las empresas seleccionadas?" } %>
  </div>

  <%= render partial: "empresas/empresas_table", locals: { empresas: @empresas } %>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("empresas_form");
    const savePath = "<%= save_all_empresas_path %>";
    const deletePath = "<%= delete_selected_empresas_path %>";

    form.addEventListener("submit", (e) => {
      const action = e.submitter?.dataset.action;

      if (action === "guardar") {
        form.action = savePath;
        form.method = "post";
      } else if (action === "eliminar") {
        form.action = deletePath;
        form.method = "post"; // use POST if DELETE is not accepted, or spoof method with `_method`
        // To spoof DELETE:
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "_method";
        input.value = "delete";
        form.appendChild(input);
      }
    });
  });
</script>


