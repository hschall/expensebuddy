<div class="container mt-4">
  <h3>Transacciones</h3>

  <!-- Periodo de tarjeta filter (auto-applies) -->
  <div class="mb-2 col-3">
    <%= select_tag :cycle_month,
      options_for_select((0..11).map { |i|
        date = Date.today.beginning_of_month - i.months
        [I18n.l(date, format: "%B %Y", locale: :es).capitalize, date.strftime("%Y-%m")]
      }, selected: params[:cycle_month]),
      prompt: "Periodo de tarjeta",
      class: "form-select",
      data: { controller: "filters", action: "change->filters#applyCycleMonth" } %>
  </div>

  <!-- Filters row -->
  <div data-controller="filters" class="row g-2 mb-3 align-items-end">
    <div class="col">
      <%= select_tag :person,
  options_for_select(current_user.transactions.distinct.pluck(:person).compact.sort, selected: params[:person]),
  prompt: "Persona",
  class: "form-select" %>
    </div>

    <div class="col">
      <%= select_tag :category_id,
    options_from_collection_for_select(current_user.categories.order(:name), :id, :name, selected: params[:category_id]),
    prompt: "CategorÃ­a",
    class: "form-select" %>

    </div>
    <div class="col">
      <%= text_field_tag :description, params[:description], placeholder: "Buscar descripciÃ³n...", class: "form-control", id: "description-filter" %>
    </div>
    <div class="col-auto">
      <button type="button" class="btn-custom-primary-sm" id="transactions-filter-button">Filtrar</button>
      <button type="button" class="btn-custom-primary-sm" id="transactions-reset-button">Resetear</button>
    </div>
  </div>

  <!-- ðŸ§¾ DASHBOARD -->
  <%= turbo_frame_tag "transactions_dashboard" do %>
    <%= render partial: "transactions/dashboard", locals: { transactions: @transactions } %>
  <% end %>

  <!-- âœ… SINGLE FORM FOR BOTH ACTIONS -->
  <%= form_with url: "", method: :post, id: "transactions_form", data: { turbo: false } do %>
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

    <div class="d-flex justify-content-start align-items-center mb-3 flex-wrap">
      <%= link_to "Nueva TransacciÃ³n", new_transaction_path, class: "btn-custom-primary-sm me-2" %>
      <%= submit_tag "Guardar cambios", class: "btn-custom-save-sm me-2", data: { action: "guardar" } %>
      <%= submit_tag "Eliminar seleccionadas", class: "btn-custom-danger-sm", data: { action: "eliminar" } %>
    </div>

    <%= turbo_frame_tag "transactions_table" do %>
      <%= render partial: "transactions/table", locals: { transactions: @transactions, with_checkboxes: true } %>
    <% end %>
  <% end %>
</div>

<!-- âœ… JS to set form action based on clicked submit -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("transactions_form");
    if (!form) return;

    form.addEventListener("submit", function (e) {
      const clickedButton = document.activeElement;
      const actionType = clickedButton?.dataset?.action;

      if (actionType === "guardar") {
        form.action = "/transactions/save_all";
        form.method = "post";
      } else if (actionType === "eliminar") {
        form.action = "/transactions/delete_selected";
        form.method = "post"; // Simulate DELETE
        const methodInput = document.createElement("input");
        methodInput.setAttribute("type", "hidden");
        methodInput.setAttribute("name", "_method");
        methodInput.setAttribute("value", "delete");
        form.appendChild(methodInput);
      } else {
        e.preventDefault();
        alert("No se pudo determinar la acciÃ³n del formulario.");
      }
    });

    // âœ… Select all checkbox behavior
    const selectAll = document.getElementById("select_all_checkbox");
    const checkboxes = document.querySelectorAll(".transaction-checkbox");

    if (selectAll) {
      selectAll.addEventListener("change", () => {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
      });
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const filterBtn = document.getElementById("transactions-filter-button");
    const resetBtn = document.getElementById("transactions-reset-button");

    const personSelect = document.querySelector("select[name='person']");
    const categorySelect = document.querySelector("select[name='category_id']");
    const descriptionInput = document.querySelector("input[name='description']");
    const cycleMonthSelect = document.querySelector("select[name='cycle_month']");

    const basePath = window.location.pathname.replace(/\/+$/, ""); // clean trailing slash

    if (filterBtn) {
      filterBtn.addEventListener("click", () => {
        const params = new URLSearchParams();

        if (personSelect?.value) params.append("person", personSelect.value);
        if (categorySelect?.value) params.append("category_id", categorySelect.value);
        if (descriptionInput?.value) params.append("description", descriptionInput.value);
        if (cycleMonthSelect?.value) params.append("cycle_month", cycleMonthSelect.value);

        window.location.href = `${basePath}?${params.toString()}`;
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        if (personSelect) personSelect.value = "";
        if (categorySelect) categorySelect.value = "";
        if (descriptionInput) descriptionInput.value = "";
        if (cycleMonthSelect) cycleMonthSelect.value = "";

        window.location.href = basePath; // reload without query params
      });
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("description-filter");
    const rows = document.querySelectorAll("#transactions_table tbody tr");

    if (!input || !rows.length) return;

    input.addEventListener("input", () => {
      const query = input.value.toLowerCase();

      rows.forEach(row => {
        const description = row.dataset.description || "";
        row.style.display = description.includes(query) ? "" : "none";
      });
    });
  });
</script>
